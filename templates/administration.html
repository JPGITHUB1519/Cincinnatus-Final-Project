{% extends "administration_base.html" %}
{% block title %} Administration {% endblock %}

{% block content %}
	<div class="content box">
		<div class="group">
			<div class="box">
				<h2 class="text-center">DashBoard</h2>
			</div>
			<div class="box">
				<canvas id="myChart" style="width: 50%;"></canvas>
			</div>
		</div>
		<div class="group">
			<div class="box">
				<h2 class="text-center">PostList</h2>
			</div>
		</div>
		<div class="table-responsive">
			<table class="table">
				<thead>
					<thead>
						<tr>
							<td>Subject</td>
							<td>Content</td>
							<td>User</td>
							<td>Date</td>
							<td>Category</td>
							<td>Update</td>
							<td>Disable</td>
							<td>Delete</td>
						</tr>
					</thead>
					<tbody>
						{% for data in list_posts %}
							{% if data.status == True %}
								<tr class="good-panel" id="row_{{ data.key().id()}}">
							{% else %}
								<tr class="error-panel" id = "row_{{ data.key().id()}}">
							{% endif %}
								<td>{{ data.subject }}</td>
								<td>{{ data.content }}</td>
								<td>{{ data.user.username }}</td>
								<td>{{ data.date }}</td>
								<td>{{ data.category.name }}</td>
								<td><a href="/newpost?p={{data.key().id()}}">Update</a></td>
								{% if data.status == True %}
									<td><a href="javascript:enable_disable_ajax('{{data.key().id()}}');" id="{{data.key().id()}}" value="{{data.key().id()}}" class="error-text little-text">Disable</a></td>
								{% else %}
									<td><a href="javascript:enable_disable_ajax('{{data.key().id()}}');" id="{{data.key().id()}}" value="{{data.key().id()}}">Enable</a></td>
								{% endif %}
								<td><a href="" id="delete_link_{{ data.key().id()}}">Delete</a></td>
							</tr>
						{% endfor %}
					</tbody>
				</thead>
			</table>
		</div>
	</div>

	<script type="text/javascript">
		/* function to get keys and values from a json sended by the server */
		function get_keys(json_data)
		{
			keys = []
			values = []
			for(data in json_data)
			{
				// if the category is not empty 
				if (json_data[data] > 0) 
				{
					keys.push(data)
					values.push(json_data[data]);
				} 	
			}
			return [keys, values];
		}
		/* getting data from the server to the chart **/
		var data_keys;
		var data;
		data_keys = get_keys({{data_json | safe}})[0]
		data = get_keys({{data_json | safe}})[1]
		var ctx = document.getElementById("myChart");
		var myChart = new Chart(ctx, {
		type: 'bar',
		data: {
			/* pass the data as a json */
		    labels:  data_keys,
		    datasets: [{
		        label: '# Post by Topic',
		        data: data,
		        scaleOverride: true,
    scaleStepWidth: 1,
    scaleStartValue: 0,
    showLegend: true,
		        backgroundColor: [
		            'rgba(255, 99, 132, 0.2)',
		            'rgba(54, 162, 235, 0.2)',
		            'rgba(255, 206, 86, 0.2)',
		            'rgba(75, 192, 192, 0.2)',
		            'rgba(153, 102, 255, 0.2)',
		            'rgba(255, 159, 64, 0.2)'
		        ],
		        borderColor: [
		            'rgba(255,99,132,1)',
		            'rgba(54, 162, 235, 1)',
		            'rgba(255, 206, 86, 1)',
		            'rgba(75, 192, 192, 1)',
		            'rgba(153, 102, 255, 1)',
		            'rgba(255, 159, 64, 1)'
		        ],
		        borderWidth: 1
		    }]
		},
		options: {
			responsive : true,
		    scales: {
		        yAxes: [{
		            ticks: {
		                beginAtZero:true
		            }
		        }]
		    }
		}
		});
		// ajax call
		function enable_disable_ajax(post_id)
		{
			$.ajax(
			{
				type : "POST",
				url : "/change_status",
				contentType: 'application/json',
				datatype : "json",
				// sent json to the server
				data : JSON.stringify({"post_id" : post_id}),
			})
			.done(function(data)
			{
				var link_id = "#" + post_id 
				var row_id = "#row_" + post_id;
				console.log(data["status"]);
				//json_reponse
				if(data["status"] == "true")
				{
					$(link_id).text("Disable");
					$(link_id).addClass("error-text");
					$(link_id).addClass("little-text");
					// quit focus when ajax
					$(link_id).blur();
					console.log(row_id);
					// changing row color
					$(row_id).addClass("good-panel");
					$(row_id).removeClass("error-panel");
				}
				else if(data["status"] == "false")
				{
					$(link_id).text("Enable");
					$(link_id).removeClass("error-text");
					// changing row color
					$(row_id).addClass("error-panel");
					$(row_id).removeClass("good-panel")
					$(link_id).blur();
				}
			})
			.fail(function(textStatus)
			{
				console.log(textStatus);
			});
			return;
		}

		function delete_post(post_id)
		{
			$.ajax(
			{
				type : "POST",
				url : "/administration",
				contentType: 'application/json',
				datatype : "json",
				// sent json to the server
				data : JSON.stringify({"post_id" : post_id, "action" : "delete_post"}),
			})
			.done(function(data)
			{
				console.log(data);
			})
			.fail(function(textStatus)
			{
				console.log(textStatus);
			});	
		}
	</script>

{% endblock %}
